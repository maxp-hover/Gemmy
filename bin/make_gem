#!/usr/bin/env ruby

# ==========================================================================
# Add this file's dir to the load path
# ==========================================================================
$:.unshift "#{__dir__}/lib"

# ==========================================================================
# Dependencies
# ==========================================================================

require 'active_support/all'
require 'pry'
require 'colored'
require_relative './lib/shell_script_lib.rb'
include Gemmy::ShellScriptLib

# ==========================================================================
# Usage instructions
# ==========================================================================

usage = <<-TXT

Usage: make_gem <name>
TXT

raise usage if ARGV.blank?
name = get_arg_or_error("Gem name should be first argument")
class_name = name.capitalize


# ==========================================================================
# Directories
# ==========================================================================

# -------------------------------------------------------------------------
# Create a root dir for the gem
# -------------------------------------------------------------------------
root_dir = name
`mkdir #{root_dir}`
puts "created root dir".green

# -------------------------------------------------------------------------
# Create lib dir
# -------------------------------------------------------------------------
lib = "#{root_dir}/lib"
`mkdir #{lib}`
puts "created lib dir".green

# -------------------------------------------------------------------------
# Write version file
# -------------------------------------------------------------------------
version_file = "#{lib}/version.rb"
version_text = <<-TXT
module #{class_name}
  VERSION = '0.0.0'
end
TXT
write(file: version_file, text: version_text)
puts "wrote version file".green

# -------------------------------------------------------------------------
# Write main gem file
# -------------------------------------------------------------------------
main_file = "#{lib}/#{name}.rb"
main_text = <<-TXT
module #{class_name}
end
TXT
write(file: main_file, text: main_text)
puts "wrote main file".green

# -------------------------------------------------------------------------
# Get more required info
# -------------------------------------------------------------------------
ARGV.clear

puts "Some info is needed for the gemspec:".red

puts "add a one-line summary. \
To add desctiption, edit the generated gemspec"
summary = gets.chomp

puts "enter the author's name"
author = gets.chomp

puts "enter the author's email"
email = gets.chomp

rubygems_version = `gem -v`.chomp

# -------------------------------------------------------------------------
# Write gemspec
# -------------------------------------------------------------------------
gemspec_file = "./#{root_dir}/#{name}.gemspec"
gemspec_text = <<-TXT

require_relative './lib/version.rb'

Gem::Specification.new do |s|
  s.name        = name
  s.version     = #{class_name}::VERSION
  s.date        = "#{Time.now.strftime("%Y-%m-%d")}"
  s.summary     = "#{summary}"
  s.description = ""
  s.platform    = Gem::Platform::RUBY
  s.authors     = ["#{author}"]
  s.email       = '#{email}'
  s.homepage    = "http://github.com/maxpleaner/gemmy"
  s.files       = Dir["lib/**/*.rb", "bin/*", "**/*.md", "LICENSE"]
  s.require_path = 'lib'
  s.required_rubygems_version = ">= #{rubygems_version}"
  s.executables = Dir["bin/*"].map &File.method(:basename)
  s.license     = 'MIT'
end
TXT
write(file: gemspec_file, text: gemspec_text)
puts "wrote gemspec".green

